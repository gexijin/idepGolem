---
title: "iDEP: Pathway Analysis"
output: 
  html_document:
    code_folding: hide
params:
  pre_processed:
  sample_info:
  all_gene_info:
  deg:
  idep_data:
  converted:
  all_gene_names:
  go:
  select_org:
  my_range:
  select_contrast:
  min_set_size:
  max_set_size:
  limma:
  gene_p_val_cutoff:
  gene_sets:
  absolute_fold:
  pathway_p_val_cutoff:
  n_pathway_show:
  contrast_samples:
  sig_pathways:
  pathway_method:
  pathway_list_data:
  up_down_reg_deg:
  wrap_text_network_deg:
  layout_vis_deg:
  edge_cutoff_deg:
  selected_pathway_data:
  heatmap_color_select:
  group_color:
  sig_pathways_kegg:
  kegg_color_select:
  kegg_colors:
  descr:
  show_pathway_id:
  printcode:
    label: "Display Code"
    value: TRUE
input: checkbox
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = params$printcode,
  warning = FALSE,
  message = FALSE
)
```

```{r libraries, include=FALSE}
library(idepGolem)
library(dplyr)
library(kableExtra)
```

<!-- This document cannot be knit directly from R studio -->
<div>

::: {style="color: Blue"}
## If this site has contributed to your work, please cite our article:

Ge, S.X., Son, E.W. & Yao, R. iDEP: an integrated web application for differential expression and pathway analysis of RNA-Seq data. BMC Bioinformatics 19, 534 (2018). <https://doi.org/10.1186/s12859-018-2486-6>
:::

</div>
------------------------------------------------------------------------

## Summary

`r params$descr`

The contrast **`r params$select_contrast`** was evaluated against the **`r params$go`** gene-set collection, restricting pathway sizes to `r params$min_set_size`-`r params$max_set_size` genes. Pathways were tested with the **`r switch(as.character(params$pathway_method), "1" = "GAGE", "2" = "PGSEA", "3" = "GSEA (Pre-Ranked)", "4" = "PGSEA with all samples", "5" = "ReactomePA", "6" = "GSVA", "7" = "ssGSEA", "8" = "PLAGE")`** workflow, applying a pathway FDR cutoff of **`r params$pathway_p_val_cutoff`** and filtering genes with DEG FDR greater than **`r params$gene_p_val_cutoff`**. Absolute fold values were `r ifelse(params$absolute_fold, "applied to emphasize magnitude changes.", "not applied, preserving directional fold changes.")`

`r if (!is.null(params$sig_pathways) && length(params$sig_pathways) > 0) paste("Heatmap previews focus on the selected significant pathways:", paste(head(params$sig_pathways, 5), collapse = ", "), if (length(params$sig_pathways) > 5) "..." else "", sep = " ") else "No individual pathways were selected for focused heatmap visualization."`

This document contains the generated plots and the full set of user-selected parameters for reproducibility.

## Analysis Settings

```{r analysis-settings, echo=FALSE}
method_label <- switch(
  as.character(params$pathway_method),
  "1" = "GAGE",
  "2" = "PGSEA",
  "3" = "GSEA (Pre-Ranked)",
  "4" = "PGSEA (All Samples)",
  "5" = "ReactomePA",
  "6" = "GSVA",
  "7" = "ssGSEA",
  "8" = "PLAGE",
  "Not specified"
)

`%||%` <- function(x, y) {
  if (is.null(x)) {
    return(y)
  }
  if (length(x) == 0) {
    return(y)
  }
  if (is.character(x) && all(x == "")) {
    return(y)
  }
  x
}

size_filter <- if (!is.null(params$min_set_size) && !is.null(params$max_set_size)) {
  paste(params$min_set_size, params$max_set_size, sep = " - ")
} else {
  "Not specified"
}

analysis_settings <- tibble::tibble(
  Setting = c(
    "Contrast",
    "Gene-set collection",
    "Method",
    "Pathways displayed",
    "Pathway size filter",
    "Pathway FDR cutoff",
    "Gene-level FDR cutoff",
    "Absolute fold filter",
    "Heatmap palette",
    "KEGG palette"
  ),
  Value = c(
    params$select_contrast %||% "Not specified",
    params$go %||% "Not specified",
    method_label,
    params$n_pathway_show %||% "Default",
    size_filter,
    params$pathway_p_val_cutoff %||% "Default",
    params$gene_p_val_cutoff %||% "Default",
    ifelse(isTRUE(params$absolute_fold), "Enabled", "Disabled"),
    params$heatmap_color_select %||% "Default",
    params$kegg_color_select %||% "Default"
  )
) %>%
  mutate(
    Value = ifelse(is.na(Value) | Value == "", "Not specified", Value)
  )

kbl(
  analysis_settings,
  col.names = c("Setting", "Value"),
  align = c("l", "l"),
  format = "html"
) %>%
  kable_classic(full_width = FALSE, html_font = "Cambria")
```

<details>
<summary><strong>Show all parameter values</strong></summary>

```{r all-params, echo=FALSE, results='asis'}
excluded_params <- c(
  "sample_info", "loaded_data", "pre_processed", "deg",
  "idep_data", "converted", "limma", "gene_sets",
  "pathway_list_data", "all_gene_names", "all_gene_info",
  "selected_pathway_data", "descr", "contrast_samples",
  "sig_pathways", "sig_pathways_kegg", "up_down_reg_deg",
  "wrap_text_network_deg", "layout_vis_deg", "edge_cutoff_deg",
  "group_color"
)

param_subset <- setdiff(names(params), excluded_params)
lines <- vapply(
  param_subset,
  function(param_name) {
    value <- params[[param_name]]
    if (is.null(value)) {
      value <- "NULL"
    } else if (length(value) > 1) {
      value <- paste(value, collapse = ", ")
    }
    paste(param_name, ":", value)
  },
  FUN.VALUE = character(1),
  USE.NAMES = FALSE
)

knitr::asis_output(paste0("<pre>", paste(lines, collapse = "\n"), "</pre>"))
```

</details>

<br>


## Gene Sets
The statement below confirms whether a curated gene-set collection was available for this run.
```{r}
# Display gene sets information from params
if (!is.null(params$gene_sets) && length(params$gene_sets) > 0) {
  print(paste("Loaded", length(params$gene_sets), "gene sets from", params$go))
} else {
  print("No gene sets available.")
}
```

<br>


## Pathway analysis for contrast: `r params$select_contrast`
The tables or heatmaps below mirror the visuals from the Pathway tab while preserving the selected enrichment algorithm.

```{r }
# Display GAGE results from pre-computed data
if (params$pathway_method == 1 && !is.null(params$pathway_list_data) && nrow(params$pathway_list_data) > 0) {
  kbl(params$pathway_list_data) %>%
    kable_classic(full_width = F, html_font = "Cambria")
} else if (params$pathway_method == 1) {
  print("No GAGE pathway data available.")
}
```

```{r PGSEA, fig.width = 6, fig.height = 10}
if (params$pathway_method == 2) {
  # only remove pathway ID for Ensembl species
  show_pathway_id <- params$show_pathway_id
  # always show pathway ID for STRING species
  if (params$select_org < 0) {
    show_pathway_id <- TRUE
  }
  plot_pgsea(
    my_range = c(params$min_set_size, params$max_set_size),
    processed_data = params$pre_processed,
    contrast_samples = params$contrast_samples,
    gene_sets = params$gene_sets,
    pathway_p_val_cutoff = params$pathway_p_val_cutoff,
    n_pathway_show = params$n_pathway_show,
    select_go = params$go,
    show_pathway_id = show_pathway_id,
    margin = c(3, 1, 13, 20)
  ) 
}
```

```{r PGSEA_all, fig.width = 8, fig.height = 10}
if (params$pathway_method == 4) {
  # only remove pathway ID for Ensembl species
  show_pathway_id <- params$show_pathway_id
  # always show pathway ID for STRING species
  if (params$select_org < 0) {
    show_pathway_id <- TRUE
  }
  pgsea_plot_all(
    go = params$go,
    my_range = c(params$min_set_size, params$max_set_size),
    data = params$pre_processed,
    select_contrast = params$contrast_samples,
    gene_sets = params$gene_sets,
    pathway_p_val_cutoff = params$pathway_p_val_cutoff,
    n_pathway_show = params$n_pathway_show,
    select_go = params$go,
    show_pathway_id = show_pathway_id,
    margin = c(3, 1, 13, 20)
  ) 
}
```

```{r gsva, fig.width = 10, fig.height = 12}
if (params$pathway_method %in% c(6:8)) {
  gsva_algorithm <- switch(
    as.numeric(params$pathway_method) - 5, 
    "gsva",   #6
    "ssgsea", #7
    "plage"   #8
  )

  # only remove pathway ID for Ensembl species
  show_pathway_id <- params$show_pathway_id
  # always show pathway ID for STRING species
  if (params$select_org < 0) {
    show_pathway_id <- TRUE
  }

    plot_gsva(
      my_range = c(params$min_set_size, params$max_set_size),
      processed_data = params$pre_processed,
      contrast_samples = params$contrast_samples,
      gene_sets = params$gene_sets,
      pathway_p_val_cutoff = params$pathway_p_val_cutoff,
      n_pathway_show = params$n_pathway_show,
      select_go = params$go,
      show_pathway_id = show_pathway_id,
      algorithm = gsva_algorithm
    )
}
```






```{r FGSEA, message = F, quiet = TRUE}
# Display FGSEA results from pre-computed data
if (params$pathway_method == 3 && !is.null(params$pathway_list_data) && nrow(params$pathway_list_data) > 0) {
  kbl(params$pathway_list_data) %>%
    kable_classic(full_width = F, html_font = "Cambria")
} else if (params$pathway_method == 3) {
  print("No FGSEA pathway data available.")
}
```





<br>

## Tree
Related pathways are clustered to highlight shared gene membership and biological themes.
```{r tree-plot, echo=FALSE, fig.width=10}
if (!is.null(params$pathway_list_data) && nrow(params$pathway_list_data) > 0) {
  idepGolem::enrichment_tree_plot(
    go_table = params$pathway_list_data,
    group = "All Groups",
    right_margin = 30
  )
} else {
  print("No pathway data available for tree plot.")
}
```

<br>


## Network plot
The enrichment network reveals how significant pathways overlap; edge width reflects shared genes while node color follows group assignments from the Pathway tab.
```{r network}
if (!is.null(params$pathway_list_data) && nrow(params$pathway_list_data) > 0) {
  network_data <- idepGolem::network_data(
    network = params$pathway_list_data,
    up_down_reg_deg = params$up_down_reg_deg,
    wrap_text_network_deg = params$wrap_text_network_deg,
    layout_vis_deg = params$layout_vis_deg,
    edge_cutoff_deg = params$edge_cutoff_deg,
    group_color = params$group_color
  )
  idepGolem::vis_network_plot(
    network_data = network_data
  )
} else {
  print("No pathway data available for network plot.")
}
```

<br>


## Heatmap
When a pathway is selected on the Heatmap tab, the corresponding genes are displayed with the chosen palette and clustering settings.

```{r pathway-name}
if (!is.null(params$sig_pathways)) {
  params$sig_pathways
}
```
```{r heatmap, fig.width = 6, fig.height = 8}
if(!is.null(params$sig_pathways) && !is.null(params$selected_pathway_data)) {
  deg_heatmap(
    df = params$selected_pathway_data,
    bar = NULL,
    heatmap_color_select = unlist(strsplit(params$heatmap_color_select, "-")),
    cluster_rows = TRUE
  )
} else {
  print("Heatmap not available (select a pathway on the Heatmap tab first).")
}
```

<br>


## KEGG pathway
For KEGG-based analyses, highlighted pathways are rendered with the chosen low/high color scale to overlay log2 fold-change statistics.

```{r, message = FALSE, fig.align='center', out.width='100%'}
if (!is.null(params$pathway_list_data) &&
    ncol(params$pathway_list_data) >= 5 &&
    !is.null(params$sig_pathways_kegg) &&
    params$go == "KEGG") {
  out_image <- kegg_pathway(
    go = params$go,
    gage_pathway_data = params$pathway_list_data[, 1:5],
    sig_pathways = params$sig_pathways_kegg,
    select_contrast = params$select_contrast,
    limma = params$limma,
    converted = params$converted,
    idep_data = params$idep_data,
    select_org = params$select_org,
    low_color = params$kegg_colors[[params$kegg_color_select]][1],
    high_color = params$kegg_colors[[params$kegg_color_select]][2]
  )
  cat(params$sig_pathways_kegg, "\n")
  if (!is.null(out_image$src) && file.exists(out_image$src)) {
    knitr::include_graphics(out_image$src)
  } else {
    message("KEGG pathway image unavailable; file was not created.")
  }
} else {
  print("KEGG pathway visualization not available (requires KEGG database selection).")
}
``` 














```{r}
# This chunk is deprecated - pathway results are displayed above
# pathway_method == 0 is not used in current version
```

```{r eval=FALSE, include=FALSE}
# PGSEA -- Not tested
if (params$pathway_method == 2) {
  res <- get_pgsea_plot_data(
    my_range = c(params$min_set_size, params$max_set_size),
    data = params$pre_process$data,
    select_contrast = params$select_contrast,
    gene_sets = params$gene_sets,
    sample_info = params$sample_info,
    select_factors_model = deg$select_factors_model,
    select_model_comprions = deg$select_model_comprions,
    pathway_p_val_cutoff = params$pathway_p_val_cutoff,
    n_pathway_show = params$n_pathway_show
  )

  pathway_list_data <- get_pathway_list_data(
    pathway_method = params$pathway_method,
    gage_pathway_data = NULL, # gage_pathway_data(),
    fgsea_pathway_data = NULL, # fgsea_pathway_data(),
    pgsea_plot_data = res,
    pgsea_plot_all_samples_data = NULL, # pgsea_plot_all_samples_data(),
    go = params$go,
    select_org = params$select_org,
    gene_info = params$all_gene_info,
    gene_sets = params$gene_sets
  )

  idepGolem::enrichment_tree_plot(
    go_table = pathway_list_data,
    group = "All Groups" # ,
    # right_margin = 45
  )
}
```

Generated using iDEP v`r packageVersion("idepGolem")` (https://bioinformatics.sdstate.edu/idep). `r format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")`. Accuracy not guaranteed.
